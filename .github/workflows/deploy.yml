name: Deploy Backend to EC2

on:
  push:
    branches:
      - develop
      - main
  workflow_dispatch:  # 수동 트리거 추가

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # 배포 브랜치 지정 (with: ref: 옵션이 없을 경우 트리거가 되는 브랜치)
      - name: Checkout branch
        uses: actions/checkout@v2
      
      # SSH Agent 설정 및 GitHub Secrets에 저장된 SSH 키 로드
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # EC2 호스트 키 등록
      - name: Add EC2 to known hosts
        run: ssh-keyscan -H ec2-13-209-47-84.ap-northeast-2.compute.amazonaws.com >> ~/.ssh/known_hosts

      # EC2에 빌드된 소스 배포
      - name: Copy source to EC2
        run: |
          scp init-index.sh ubuntu@ec2-13-209-47-84.ap-northeast-2.compute.amazonaws.com:/home/ubuntu/catchweak
          
          scp docker-compose.yml ubuntu@ec2-13-209-47-84.ap-northeast-2.compute.amazonaws.com:/home/ubuntu/catchweak
          
          scp -r build/libs ubuntu@ec2-13-209-47-84.ap-northeast-2.compute.amazonaws.com:/home/ubuntu/catchweak
          
      # 서버 실행
      - name: SSH into EC2 and run backend deployment
        run: |
          ssh ubuntu@ec2-13-209-47-84.ap-northeast-2.compute.amazonaws.com << EOF
            cd /home/ubuntu/catchweak
            ./gradlew build
            nohup java -jar build/libs/catchweak.jar &
          EOF
